# 秒杀功能接口文档（更新版）

## 文档说明
本文档基于苍穹外卖项目现有架构，设计秒杀功能相关接口。遵循项目开发规范，确保与现有系统完美集成，所有接口使用UTF-8编码。

**更新说明**: 本文档已根据实际代码实现情况进行更新，标记了已实现和未实现的功能。

## 接口规范说明
- **基础路径**: 
  - 管理端: `/admin/seckill`
  - 用户端: `/user/seckill`
- **认证方式**: JWT Token认证
- **响应格式**: 统一使用项目标准Result格式
- **字符编码**: UTF-8
- **时间格式**: yyyy-MM-dd HH:mm:ss

---

## 1. 管理端接口（商家端）

### 1.1 秒杀活动管理

#### 1.1.1 分页查询秒杀活动列表 ? **已实现**
**接口地址**: `GET /admin/seckill/activity/page`

**接口描述**: 商家查询秒杀活动列表，支持分页和条件筛选

**请求参数**:
```json
{
  "page": 1,
  "pageSize": 10,
  "name": "活动名称（可选）",
  "status": 1
}
```

**响应数据**:
```json
{
  "code": 1,
  "msg": "success",
  "data": {
    "total": 100,
    "records": [
      {
        "id": 1,
        "name": "限时秒杀活动",
        "image": "https://kuikuiwww.oss-cn-guangzhou.aliyuncs.com/seckill-banner.png",
        "startTime": "2025-08-20 10:00:00",
        "endTime": "2025-08-20 12:00:00",
        "status": 1,
        "description": "限时2小时秒杀活动，数量有限，先到先得！",
        "createTime": "2025-08-16 15:00:00",
        "updateTime": "2025-08-16 15:00:00",
        "goodsCount": 5
      }
    ]
  }
}
```

#### 1.1.2 新增秒杀活动 ? **已实现**
**接口地址**: `POST /admin/seckill/activity`

**接口描述**: 商家创建新的秒杀活动

**请求参数**:
```json
{
  "name": "限时秒杀活动",
  "image": "https://kuikuiwww.oss-cn-guangzhou.aliyuncs.com/seckill-banner.png",
  "startTime": "2025-08-20 10:00:00",
  "endTime": "2025-08-20 12:00:00",
  "description": "限时2小时秒杀活动，数量有限，先到先得！",
  "goodsList": [
    {
      "goodsType": 1,
      "goodsId": 46,
      "goodsName": "王老吉",
      "goodsImage": "https://sky-itcast.oss-cn-beijing.aliyuncs.com/41bfcacf-7ad4-4927-8b26-df366553a94c.png",
      "originalPrice": 6.00,
      "seckillPrice": 3.00,
      "totalStock": 100,
      "limitCount": 2
    }
  ]
}
```

**响应数据**:
```json
{
  "code": 1,
  "msg": "success",
  "data": null
}
```

#### 1.1.3 修改秒杀活动 ? **已实现**
**接口地址**: `PUT /admin/seckill/activity`

**接口描述**: 商家修改秒杀活动信息（仅未开始的活动可修改）

**请求参数**:
```json
{
  "id": 1,
  "name": "限时秒杀活动",
  "image": "https://kuikuiwww.oss-cn-guangzhou.aliyuncs.com/seckill-banner.png",
  "startTime": "2025-08-20 10:00:00",
  "endTime": "2025-08-20 12:00:00",
  "description": "限时2小时秒杀活动，数量有限，先到先得！"
}
```

**响应数据**:
```json
{
  "code": 1,
  "msg": "success",
  "data": null
}
```

#### 1.1.4 删除秒杀活动 ? **已实现**
**接口地址**: `DELETE /admin/seckill/activity`

**接口描述**: 删除秒杀活动（仅未开始的活动可删除）

**请求参数**:
```json
{
  "id": 1
}
```

**响应数据**:
```json
{
  "code": 1,
  "msg": "success",
  "data": null
}
```

#### 1.1.5 查询秒杀活动详情 ? **已实现**
**接口地址**: `GET /admin/seckill/activity/{id}`

**接口描述**: 查询指定秒杀活动的详细信息

**路径参数**:
- `id`: 活动ID

**响应数据**:
```json
{
  "code": 1,
  "msg": "success",
  "data": {
    "id": 1,
    "name": "限时秒杀活动",
    "image": "https://kuikuiwww.oss-cn-guangzhou.aliyuncs.com/seckill-banner.png",
    "startTime": "2025-08-20 10:00:00",
    "endTime": "2025-08-20 12:00:00",
    "status": 1,
    "description": "限时2小时秒杀活动，数量有限，先到先得！",
    "createTime": "2025-08-16 15:00:00",
    "updateTime": "2025-08-16 15:00:00",
    "goodsList": [
      {
        "id": 1,
        "goodsType": 1,
        "goodsId": 46,
        "goodsName": "王老吉",
        "goodsImage": "https://sky-itcast.oss-cn-beijing.aliyuncs.com/41bfcacf-7ad4-4927-8b26-df366553a94c.png",
        "originalPrice": 6.00,
        "seckillPrice": 3.00,
        "totalStock": 100,
        "availableStock": 85,
        "soldCount": 15,
        "limitCount": 2,
        "status": 1
      }
    ]
  }
}
```

#### 1.1.6 启用/停用秒杀活动 ? **已实现**
**接口地址**: `POST /admin/seckill/activity/status/{status}`

**接口描述**: 启用或停用秒杀活动

**路径参数**:
- `status`: 状态值（0:停用 1:启用）

**请求参数**:
```json
{
  "id": 1
}
```

**响应数据**:
```json
{
  "code": 1,
  "msg": "success",
  "data": null
}
```

### 1.2 秒杀商品管理

#### 1.2.1 查询可用商品列表 ? **已实现**
**接口地址**: `GET /admin/seckill/goods/available`

**接口描述**: 获取可添加到秒杀活动的菜品和套餐列表

**请求参数**:
```json
{
  "type": 1,
  "name": "商品名称（可选）"
}
```

**响应数据**:
```json
{
  "code": 1,
  "msg": "success",
  "data": [
    {
      "id": 46,
      "name": "王老吉",
      "image": "https://sky-itcast.oss-cn-beijing.aliyuncs.com/41bfcacf-7ad4-4927-8b26-df366553a94c.png",
      "price": 6.00,
      "type": 1,
      "categoryName": "酒水饮料"
    }
  ]
}
```

#### 1.2.2 修改秒杀商品信息 ? **已实现**
**接口地址**: `PUT /admin/seckill/goods`

**接口描述**: 修改秒杀商品的价格、库存等信息

**请求参数**:
```json
{
  "id": 1,
  "seckillPrice": 3.00,
  "totalStock": 150,
  "limitCount": 3
}
```

**响应数据**:
```json
{
  "code": 1,
  "msg": "success",
  "data": null
}
```

#### 1.2.3 删除秒杀商品 ? **已实现**
**接口地址**: `DELETE /admin/seckill/goods`

**接口描述**: 从秒杀活动中删除商品

**请求参数**:
```json
{
  "id": 1
}
```

**响应数据**:
```json
{
  "code": 1,
  "msg": "success",
  "data": null
}
```

### 1.3 秒杀订单管理

#### 1.3.1 查询秒杀订单列表 ? **已实现**
**接口地址**: `GET /admin/seckill/order/page`

**接口描述**: 分页查询秒杀订单（集成到现有订单管理中）

**请求参数**:
```json
{
  "page": 1,
  "pageSize": 10,
  "status": 2
}
```

**注意**: 实际实现中参数简化了，不支持按订单号、手机号、时间范围筛选

**响应数据**:
```json
{
  "code": 1,
  "msg": "success",
  "data": {
    "total": 50,
    "records": [
      {
        "id": 1,
        "number": "1755102031104",
        "status": 2,
        "userId": 4,
        "orderTime": "2025-08-20 10:30:00",
        "checkoutTime": "2025-08-20 10:30:02",
        "payMethod": 1,
        "payStatus": 1,
        "amount": 3.00,
        "userName": "用户001",
        "phone": "18026714983",
        "address": "北京市海淀区上地十街10号",
        "consignee": "张三",
        "seckillInfo": {
          "activityName": "限时秒杀活动",
          "goodsName": "王老吉",
          "seckillPrice": 3.00,
          "quantity": 1
        }
      }
    ]
  }
}
```

#### 1.3.2 查询秒杀订单详情 ? **已实现**
**接口地址**: `GET /admin/seckill/order/details/{id}`

**接口描述**: 查询秒杀订单详细信息

**路径参数**:
- `id`: 订单ID

**响应数据**:
```json
{
  "code": 1,
  "msg": "success",
  "data": {
    "id": 1,
    "number": "1755102031104",
    "status": 2,
    "userId": 4,
    "orderTime": "2025-08-20 10:30:00",
    "checkoutTime": "2025-08-20 10:30:02",
    "payMethod": 1,
    "payStatus": 1,
    "amount": 3.00,
    "remark": "",
    "userName": "用户001",
    "phone": "18026714983",
    "address": "北京市海淀区上地十街10号",
    "consignee": "张三",
    "seckillInfo": {
      "activityId": 1,
      "activityName": "限时秒杀活动",
      "seckillGoodsId": 1,
      "goodsName": "王老吉",
      "goodsImage": "https://sky-itcast.oss-cn-beijing.aliyuncs.com/41bfcacf-7ad4-4927-8b26-df366553a94c.png",
      "originalPrice": 6.00,
      "seckillPrice": 3.00,
      "quantity": 1
    }
  }
}
```

### 1.4 秒杀数据统计

#### 1.4.1 查询秒杀活动统计数据 ? **未完整实现**
**接口地址**: `GET /admin/seckill/statistics`

**接口描述**: 查询秒杀活动的统计数据

**实现状态**: ? **Controller已定义，但Service层统计逻辑未实现**

**请求参数**:
```json
{
  "activityId": 1,
  "beginDate": "2025-08-20",
  "endDate": "2025-08-20"
}
```

**响应数据**:
```json
{
  "code": 1,
  "msg": "success",
  "data": {
    "totalOrders": 0,
    "successOrders": 0,
    "totalAmount": 0.0,
    "totalStock": 0,
    "soldCount": 0,
    "successRate": 0.0
  }
}
```

**需要实现**: 
- `SeckillActivityService.getStatistics()` 方法
- 统计逻辑包括：总订单数、成功订单数、总金额、总库存、销售数量、成功率计算

---

## 2. 用户端接口

### 2.1 秒杀活动展示

#### 2.1.1 查询进行中的秒杀活动 ? **已实现**
**接口地址**: `GET /user/seckill/activity/active`

**接口描述**: 获取当前进行中的秒杀活动，用于首页横幅展示

**响应数据**:
```json
{
  "code": 1,
  "msg": "success",
  "data": [
    {
      "id": 1,
      "name": "限时秒杀活动",
      "image": "https://kuikuiwww.oss-cn-guangzhou.aliyuncs.com/seckill-banner.png",
      "startTime": "2025-08-20 10:00:00",
      "endTime": "2025-08-20 12:00:00",
      "status": 1,
      "description": "限时2小时秒杀活动，数量有限，先到先得！",
      "remainingTime": 3600
    }
  ]
}
```

#### 2.1.2 查询秒杀活动商品列表 ? **已实现**
**接口地址**: `GET /user/seckill/activity/{activityId}/goods`

**接口描述**: 获取指定秒杀活动的商品列表

**路径参数**:
- `activityId`: 活动ID

**响应数据**:
```json
{
  "code": 1,
  "msg": "success",
  "data": [
    {
      "id": 1,
      "activityId": 1,
      "goodsType": 1,
      "goodsId": 46,
      "goodsName": "王老吉",
      "goodsImage": "https://sky-itcast.oss-cn-beijing.aliyuncs.com/41bfcacf-7ad4-4927-8b26-df366553a94c.png",
      "originalPrice": 6.00,
      "seckillPrice": 3.00,
      "availableStock": 85,
      "soldCount": 15,
      "limitCount": 2,
      "userPurchased": 0,
      "canPurchase": true
    }
  ]
}
```

#### 2.1.3 查询秒杀商品详情 ? **已实现**
**接口地址**: `GET /user/seckill/goods/{id}`

**接口描述**: 获取秒杀商品的详细信息

**路径参数**:
- `id`: 秒杀商品ID

**响应数据**:
```json
{
  "code": 1,
  "msg": "success",
  "data": {
    "id": 1,
    "activityId": 1,
    "activityName": "限时秒杀活动",
    "goodsType": 1,
    "goodsId": 46,
    "goodsName": "王老吉",
    "goodsImage": "https://sky-itcast.oss-cn-beijing.aliyuncs.com/41bfcacf-7ad4-4927-8b26-df366553a94c.png",
    "originalPrice": 6.00,
    "seckillPrice": 3.00,
    "availableStock": 85,
    "soldCount": 15,
    "limitCount": 2,
    "userPurchased": 0,
    "canPurchase": true,
    "startTime": "2025-08-20 10:00:00",
    "endTime": "2025-08-20 12:00:00",
    "remainingTime": 3600,
    "description": "还是小时候的味道"
  }
}
```

### 2.2 秒杀下单流程

#### 2.2.1 立即购买（生成秒杀订单） ? **已实现**
**接口地址**: `POST /user/seckill/order/submit`

**接口描述**: 用户提交秒杀订单

**请求参数**:
```json
{
  "seckillGoodsId": 1,
  "quantity": 1,
  "addressBookId": 1,
  "remark": "尽快配送"
}
```

**响应数据**:
```json
{
  "code": 1,
  "msg": "success",
  "data": {
    "orderId": 100,
    "orderNumber": "1755102031104",
    "payExpireTime": "2025-08-20 10:45:00",
    "totalAmount": 3.00,
    "payTimeLimit": 900
  }
}
```

#### 2.2.2 秒杀订单支付 ? **已实现**
**接口地址**: `PUT /user/seckill/order/payment`

**接口描述**: 秒杀订单支付

**请求参数**:
```json
{
  "orderNumber": "1755102031104",
  "payMethod": 1
}
```

**响应数据**:
```json
{
  "code": 1,
  "msg": "success",
  "data": {
    "nonceStr": "5K8264ILTKCH16CQ2502SI8ZNMTM67VS",
    "paySign": "C380BEC2BFD727A4B6845133519F3AD6",
    "timeStamp": "1640966792",
    "signType": "RSA",
    "packageStr": "prepay_id=wx20112619131321"
  }
}
```

#### 2.2.3 取消秒杀订单 ? **已实现**
**接口地址**: `PUT /user/seckill/order/cancel/{id}`

**接口描述**: 用户取消未支付的秒杀订单

**路径参数**:
- `id`: 订单ID

**响应数据**:
```json
{
  "code": 1,
  "msg": "success",
  "data": null
}
```

### 2.3 秒杀订单查询

#### 2.3.1 查询用户秒杀订单列表 ? **已实现**
**接口地址**: `GET /user/seckill/order/list`

**接口描述**: 用户查询自己的秒杀订单列表

**请求参数**:
```json
{
  "page": 1,
  "pageSize": 10,
  "status": 2
}
```

**响应数据**:
```json
{
  "code": 1,
  "msg": "success",
  "data": {
    "total": 10,
    "records": [
      {
        "id": 1,
        "number": "1755102031104",
        "status": 2,
        "orderTime": "2025-08-20 10:30:00",
        "payStatus": 1,
        "amount": 3.00,
        "seckillInfo": {
          "activityName": "限时秒杀活动",
          "goodsName": "王老吉",
          "goodsImage": "https://sky-itcast.oss-cn-beijing.aliyuncs.com/41bfcacf-7ad4-4927-8b26-df366553a94c.png",
          "seckillPrice": 3.00,
          "quantity": 1
        }
      }
    ]
  }
}
```

#### 2.3.2 查询秒杀订单详情 ? **已实现**
**接口地址**: `GET /user/seckill/order/details/{id}`

**接口描述**: 用户查询秒杀订单详细信息

**路径参数**:
- `id`: 订单ID

**响应数据**:
```json
{
  "code": 1,
  "msg": "success",
  "data": {
    "id": 1,
    "number": "1755102031104",
    "status": 2,
    "orderTime": "2025-08-20 10:30:00",
    "checkoutTime": "2025-08-20 10:30:02",
    "payMethod": 1,
    "payStatus": 1,
    "amount": 3.00,
    "remark": "尽快配送",
    "phone": "18026714983",
    "address": "北京市海淀区上地十街10号",
    "consignee": "张三",
    "estimatedDeliveryTime": "2025-08-20 11:30:00",
    "seckillInfo": {
      "activityName": "限时秒杀活动",
      "goodsName": "王老吉",
      "goodsImage": "https://sky-itcast.oss-cn-beijing.aliyuncs.com/41bfcacf-7ad4-4927-8b26-df366553a94c.png",
      "originalPrice": 6.00,
      "seckillPrice": 3.00,
      "quantity": 1
    }
  }
}
```

#### 2.3.3 再来一单 ? **已实现**
**接口地址**: `POST /user/seckill/order/again/{id}`

**接口描述**: 基于历史秒杀订单再次购买（如果商品仍在秒杀中）

**路径参数**:
- `id`: 原订单ID

**响应数据**:
```json
{
  "code": 1,
  "msg": "success",
  "data": {
    "orderId": 101,
    "orderNumber": "1755102031105",
    "payExpireTime": "2025-08-20 11:45:00",
    "totalAmount": 3.00,
    "payTimeLimit": 900
  }
}
```

### 2.4 用户限购检查

#### 2.4.1 检查用户购买资格 ? **已实现**
**接口地址**: `GET /user/seckill/check/eligibility`

**接口描述**: 检查用户是否可以购买指定秒杀商品

**请求参数**:
```json
{
  "seckillGoodsId": 1,
  "quantity": 1
}
```

**响应数据**:
```json
{
  "code": 1,
  "msg": "success",
  "data": {
    "canPurchase": true,
    "remainingQuota": 2,
    "limitCount": 2,
    "userPurchased": 0,
    "availableStock": 85
  }
}
```

---

## 3. 错误码说明

### 3.1 秒杀业务错误码
| 错误码 | 错误信息 | 说明 |
|--------|----------|------|
| 50001 | 秒杀活动不存在 | 指定的秒杀活动ID不存在 |
| 50002 | 秒杀活动未开始 | 用户访问未开始的秒杀活动 |
| 50003 | 秒杀活动已结束 | 用户访问已结束的秒杀活动 |
| 50004 | 秒杀商品不存在 | 指定的秒杀商品不存在 |
| 50005 | 秒杀商品已下架 | 商品状态为下架 |
| 50006 | 库存不足 | 秒杀商品库存不足 |
| 50007 | 超出限购数量 | 用户购买数量超过限制 |
| 50008 | 用户已达购买上限 | 用户已购买达到限购数量 |
| 50009 | 订单支付超时 | 秒杀订单支付超时自动取消 |
| 50010 | 系统繁忙，请稍后重试 | 系统限流触发 |

### 3.2 错误响应格式
```json
{
  "code": 50006,
  "msg": "库存不足",
  "data": null
}
```

---

## 4. 接口安全说明

### 4.1 限流策略
- **秒杀下单接口**: 单用户每秒最多1次请求
- **商品详情接口**: 单用户每秒最多5次请求
- **活动列表接口**: 单用户每秒最多10次请求

### 4.2 防刷机制
- 基于用户ID进行限购控制
- 订单支付15分钟超时自动取消
- 库存扣减使用乐观锁防止超卖

### 4.3 数据校验
- 所有时间参数进行格式校验
- 价格参数精度校验（保留2位小数）
- 库存数量必须为正整数

---

## 5. 接口集成说明

### 5.1 与现有订单系统集成
- 秒杀订单复用现有`orders`表结构
- 通过`seckill_order`表扩展秒杀特有字段
- 订单状态流转与普通订单保持一致

### 5.2 与现有商品系统集成
- 秒杀商品关联现有`dish`和`setmeal`表
- 保持商品基本信息一致性
- 仅在秒杀期间进行库存管理

### 5.3 缓存策略
- 活动信息缓存5分钟
- 商品库存实时更新
- 用户购买记录缓存至活动结束

---

## 6. 实现状态总结

### ? **已完整实现的功能** (21个接口)
1. **管理端活动管理** (6个)
   - 分页查询秒杀活动列表
   - 新增秒杀活动
   - 修改秒杀活动
   - 删除秒杀活动
   - 查询秒杀活动详情
   - 启用/停用秒杀活动

2. **管理端商品管理** (3个)
   - 查询可用商品列表
   - 修改秒杀商品信息
   - 删除秒杀商品

3. **管理端订单管理** (2个)
   - 查询秒杀订单列表
   - 查询秒杀订单详情

4. **用户端活动展示** (3个)
   - 查询进行中的秒杀活动
   - 查询秒杀活动商品列表
   - 查询秒杀商品详情

5. **用户端下单流程** (3个)
   - 立即购买（生成秒杀订单）
   - 秒杀订单支付
   - 取消秒杀订单

6. **用户端订单查询** (3个)
   - 查询用户秒杀订单列表
   - 查询秒杀订单详情
   - 再来一单

7. **用户限购检查** (1个)
   - 检查用户购买资格

### ? **未完整实现的功能** (1个接口)
1. **管理端统计功能** (1个)
   - 查询秒杀活动统计数据 - Controller已定义，但Service层统计逻辑未实现

### ? **需要完善的部分**
1. **SeckillActivityService.getStatistics()** 方法实现
   - 统计总订单数、成功订单数
   - 计算总金额、成功率
   - 统计库存和销售数据

2. **管理端订单查询优化**
   - 当前实现较简单，可增加更多筛选条件
   - 支持按订单号、手机号、时间范围筛选

---

**注意事项**：
1. 所有接口都需要添加完整的Swagger文档注解
2. 涉及中文字符的响应数据必须使用UTF-8编码
3. 关键业务操作必须记录详细日志
4. 数据库操作必须考虑事务一致性
5. 高并发接口需要进行压力测试验证
6. 统计接口需要尽快实现以完善功能完整性

本接口文档将随功能开发进展持续更新完善。
