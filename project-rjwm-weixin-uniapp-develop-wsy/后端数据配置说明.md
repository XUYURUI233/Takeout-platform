# 秒杀功能后端数据配置说明

## 概述

秒杀功能已配置为优先使用后端数据库数据，只有在API调用失败或无数据时才会使用模拟数据作为备用方案。

## API接口配置

### 1. 必需的后端接口

根据接口文档，需要确保以下后端接口正常工作：

#### 用户端接口
```
GET /user/seckill/activity/active           # 获取进行中的秒杀活动
GET /user/seckill/activity/{activityId}/goods  # 获取活动商品列表  
GET /user/seckill/goods/{id}                # 获取商品详情
POST /user/seckill/order/submit             # 提交秒杀订单
PUT /user/seckill/order/payment             # 订单支付
PUT /user/seckill/order/cancel/{id}         # 取消订单
GET /user/seckill/check/eligibility         # 检查购买资格
GET /user/addressBook/default               # 获取默认地址
GET /user/shop/status                       # 获取店铺状态
```

### 2. 数据库表结构

确保以下表已创建并有测试数据：

```sql
-- 秒杀活动表
seckill_activity
-- 秒杀商品表  
seckill_goods
-- 秒杀订单表
seckill_order
-- 用户购买记录表
seckill_user_record
-- 库存操作日志表
seckill_stock_log
```

## 前端数据流程

### 1. 秒杀横幅组件

```javascript
// 优先调用后端API
const res = await getActiveSeckillActivities()
if (res.code === 1 && res.data && res.data.length > 0) {
  // 使用后端数据
  this.seckillActivities = res.data
} else {
  // 后备方案：使用模拟数据
  this.loadMockData()
}
```

**数据要求**：
- 活动必须有有效的时间范围（startTime < 当前时间 < endTime）
- status = 1（活动状态为进行中）
- 包含必要字段：id, name, description, image, startTime, endTime

### 2. 活动详情页面

```javascript
// 从活动列表中查找对应活动
const activity = activitiesRes.data.find(item => item.id == this.activityId)
// 加载该活动的商品列表
const goodsRes = await getSeckillGoodsByActivityId(this.activityId)
```

**数据要求**：
- 活动ID必须匹配
- 商品列表包含字段：id, goodsName, goodsImage, originalPrice, seckillPrice, availableStock, limitCount

### 3. 商品详情页面

```javascript
// 获取单个商品的详细信息
const res = await getSeckillGoodsDetail(this.goodsId)
```

**数据要求**：
- 包含完整商品信息
- 活动时间信息
- 用户购买记录（userPurchased）
- 库存信息（availableStock）

### 4. 订单页面

```javascript
// 获取商品信息用于订单确认
const goodsRes = await getSeckillGoodsDetail(this.goodsId)
// 获取默认收货地址
const addressRes = await getAddressBookDefault()
```

## 调试和监控

### 1. 控制台日志

所有API调用都会输出详细的调试信息：

```javascript
console.log('开始加载秒杀活动数据...')
console.log('API响应:', res)
console.log('使用后端数据:', this.seckillActivities)
```

### 2. 数据验证

在浏览器开发者工具中检查：
- Network标签页：确认API请求正常发送和响应
- Console标签页：查看数据加载日志
- Vue DevTools：检查组件数据状态

### 3. 错误处理

当后端数据不可用时的处理策略：

1. **API调用失败**：显示"API调用失败，使用模拟数据"
2. **数据格式错误**：显示"后端数据格式错误，使用模拟数据"  
3. **无数据返回**：显示"后端无数据，使用模拟数据"

## 后端开发要求

### 1. 数据格式规范

所有API响应必须遵循统一格式：

```json
{
  "code": 1,
  "msg": "success", 
  "data": {
    // 具体数据
  }
}
```

### 2. 字符编码

- 数据库使用UTF-8编码
- API响应使用UTF-8编码
- 所有中文字符正确显示

### 3. 时间格式

统一使用格式：`yyyy-MM-dd HH:mm:ss`

```json
{
  "startTime": "2025-08-20 10:00:00",
  "endTime": "2025-08-20 12:00:00"
}
```

### 4. 状态码定义

```json
{
  "activity_status": {
    "0": "未开始",
    "1": "进行中", 
    "2": "已结束",
    "3": "已取消"
  },
  "goods_status": {
    "0": "下架",
    "1": "上架"
  }
}
```

## 测试数据示例

### 1. 秒杀活动数据

```sql
INSERT INTO seckill_activity VALUES (
  1, 
  '限时秒杀活动',
  'https://kuikuiwww.oss-cn-guangzhou.aliyuncs.com/seckill-banner.png',
  NOW() - INTERVAL 30 MINUTE,  -- 30分钟前开始
  NOW() + INTERVAL 90 MINUTE,  -- 90分钟后结束  
  1,
  '限时2小时秒杀，数量有限，先到先得！',
  NOW(),
  NOW(),
  1,
  1
);
```

### 2. 秒杀商品数据

```sql
INSERT INTO seckill_goods VALUES (
  1,
  1,  -- activity_id
  1,  -- goods_type (1:菜品)
  46, -- goods_id (关联dish表)
  '王老吉',
  'https://sky-itcast.oss-cn-beijing.aliyuncs.com/41bfcacf-7ad4-4927-8b26-df366553a94c.png',
  6.00,   -- 原价
  3.00,   -- 秒杀价
  100,    -- 总库存
  85,     -- 可用库存
  15,     -- 已售数量
  2,      -- 限购数量
  0,      -- 版本号
  1,      -- 状态
  NOW(),
  NOW(),
  1,
  1
);
```

## 部署检查清单

- [ ] 后端API接口部署完成
- [ ] 数据库表结构创建完成
- [ ] 测试数据插入完成
- [ ] API接口返回正确格式数据
- [ ] 字符编码设置正确
- [ ] 跨域配置正确
- [ ] 接口权限配置正确
- [ ] 前端API地址配置正确

## 常见问题排查

### 1. 横幅不显示

**检查步骤**：
1. 确认店铺状态API返回status=1
2. 确认秒杀活动API返回有效数据
3. 确认活动时间范围正确
4. 检查浏览器控制台错误信息

### 2. 商品列表为空

**检查步骤**：
1. 确认活动ID传递正确
2. 确认商品表中有对应活动的数据
3. 确认商品状态为上架(status=1)
4. 检查API接口返回数据格式

### 3. 订单提交失败

**检查步骤**：
1. 确认用户登录状态
2. 确认商品库存充足
3. 确认用户购买限制
4. 检查订单提交接口参数

通过以上配置，秒杀功能将优先使用后端真实数据，确保功能的完整性和数据一致性。

