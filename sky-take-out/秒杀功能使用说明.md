# 苍穹外卖秒杀功能使用说明

## 功能概述

本秒杀功能基于苍穹外卖项目现有架构开发，完全遵循项目开发规范，实现了完整的秒杀活动管理和用户秒杀下单流程。

## 主要特性

### 1. 核心功能
- ? 秒杀活动管理（增删改查）
- ? 秒杀商品管理（支持菜品和套餐）
- ? 秒杀订单处理（下单、支付、取消）
- ? 用户限购控制
- ? 库存防超卖（乐观锁）
- ? 订单支付超时处理

### 2. 技术特性
- ? 乐观锁防超卖机制
- ? 定时任务处理超时订单
- ? 完整的操作日志记录
- ? 支持高并发场景
- ? 完整的权限控制

## 数据库表结构

### 核心表说明

1. **seckill_activity** - 秒杀活动表
   - 管理秒杀活动的基本信息
   - 支持活动状态管理

2. **seckill_goods** - 秒杀商品表
   - 管理参与秒杀的商品信息
   - 包含库存管理和乐观锁版本控制

3. **seckill_order** - 秒杀订单表
   - 关联现有orders表，扩展秒杀功能
   - 支持支付超时控制

4. **seckill_user_record** - 用户购买记录表
   - 防止用户重复购买，控制限购

5. **seckill_stock_log** - 库存操作日志表
   - 追踪所有库存变更操作

## API接口说明

### 管理端接口 (/admin/seckill)

#### 秒杀活动管理
- `GET /activity/page` - 分页查询秒杀活动
- `POST /activity` - 新增秒杀活动
- `PUT /activity` - 修改秒杀活动
- `DELETE /activity` - 删除秒杀活动
- `GET /activity/{id}` - 查询活动详情
- `POST /activity/status/{status}` - 启用/停用活动

#### 秒杀商品管理
- `GET /goods/available` - 查询可用商品列表
- `PUT /goods` - 修改秒杀商品信息
- `DELETE /goods` - 删除秒杀商品

#### 秒杀订单管理
- `GET /order/page` - 分页查询秒杀订单
- `GET /order/details/{id}` - 查询订单详情
- `GET /statistics` - 查询统计数据

### 用户端接口 (/user/seckill)

#### 秒杀活动展示
- `GET /activity/active` - 查询进行中的秒杀活动
- `GET /activity/{activityId}/goods` - 查询活动商品列表
- `GET /goods/{id}` - 查询商品详情

#### 秒杀下单流程
- `POST /order/submit` - 提交秒杀订单
- `PUT /order/payment` - 订单支付
- `PUT /order/cancel/{id}` - 取消订单

#### 订单查询
- `GET /order/list` - 查询用户订单列表
- `GET /order/details/{id}` - 查询订单详情
- `POST /order/again/{id}` - 再来一单

#### 购买资格检查
- `GET /check/eligibility` - 检查购买资格

## 使用流程

### 1. 商家端操作流程

1. **创建秒杀活动**
   ```
   登录管理后台 → 秒杀管理 → 新增活动 → 填写活动信息 → 添加商品 → 保存
   ```

2. **管理秒杀商品**
   ```
   选择可用商品 → 设置秒杀价格 → 设置库存数量 → 设置限购数量 → 确认
   ```

3. **启用秒杀活动**
   ```
   活动列表 → 选择活动 → 点击启用 → 活动开始
   ```

### 2. 用户端操作流程

1. **浏览秒杀活动**
   ```
   打开APP → 查看秒杀横幅 → 点击进入秒杀页面 → 浏览商品
   ```

2. **参与秒杀**
   ```
   选择商品 → 查看详情 → 立即购买 → 选择地址 → 提交订单 → 限时支付
   ```

3. **订单管理**
   ```
   个人中心 → 我的订单 → 筛选秒杀订单 → 查看详情
   ```

## 防超卖机制

### 乐观锁实现
```sql
UPDATE seckill_goods 
SET available_stock = available_stock - #{quantity}, 
    sold_count = sold_count + #{quantity},
    version = version + 1,
    update_time = NOW()
WHERE id = #{seckillGoodsId} 
  AND available_stock >= #{quantity} 
  AND version = #{version}
  AND status = 1;
```

### 关键点
1. 使用version字段作为乐观锁
2. 检查库存是否充足
3. 原子性更新库存和销量
4. 记录详细的操作日志

## 限购控制

### 实现机制
1. **数据库唯一索引**: 防止重复购买记录
2. **购买前检查**: 验证用户已购买数量
3. **实时更新**: 每次购买后更新用户记录

### 检查流程
```java
// 1. 查询用户购买记录
SeckillUserRecord record = seckillUserRecordMapper.getByActivityGoodsUser(activityId, goodsId, userId);

// 2. 计算剩余购买额度
int userPurchased = record != null ? record.getQuantity() : 0;
int remainingQuota = goods.getLimitCount() - userPurchased;

// 3. 验证购买数量
if (userPurchased + quantity > goods.getLimitCount()) {
    throw new BaseException("超出限购数量");
}
```

## 订单超时处理

### 定时任务
- 每分钟执行一次超时订单检查
- 自动取消超时未支付订单
- 释放被占用的库存

### 处理流程
1. 查询超时未支付订单
2. 更新订单状态为已取消
3. 释放对应的库存数量
4. 记录操作日志

## 缓存策略建议

### Redis缓存设计
```
活动缓存: seckill:activity:{activityId}
库存缓存: seckill:stock:{goodsId}
用户限购缓存: seckill:user:{userId}:{goodsId}
```

### 缓存更新
- 采用缓存与数据库双写模式
- 关键操作后及时更新缓存
- 设置合理的过期时间

## 错误码说明

| 错误码 | 错误信息 | 说明 |
|--------|----------|------|
| 50001 | 秒杀活动不存在 | 指定的秒杀活动ID不存在 |
| 50002 | 秒杀活动未开始 | 用户访问未开始的秒杀活动 |
| 50003 | 秒杀活动已结束 | 用户访问已结束的秒杀活动 |
| 50004 | 秒杀商品不存在 | 指定的秒杀商品不存在 |
| 50005 | 秒杀商品已下架 | 商品状态为下架 |
| 50006 | 库存不足 | 秒杀商品库存不足 |
| 50007 | 超出限购数量 | 用户购买数量超过限制 |
| 50008 | 用户已达购买上限 | 用户已购买达到限购数量 |
| 50009 | 订单支付超时 | 秒杀订单支付超时自动取消 |
| 50010 | 系统繁忙，请稍后重试 | 系统限流触发 |

## 性能优化建议

### 1. 数据库优化
- 合理设置数据库连接池大小
- 添加必要的索引
- 使用读写分离

### 2. 缓存优化
- 热点数据预热到Redis
- 使用分布式锁避免缓存击穿
- 设置合理的缓存过期策略

### 3. 限流策略
- 接口级别限流
- 用户级别限流
- 商品级别限流

## 监控告警

### 关键指标监控
- 库存扣减成功率
- 订单支付超时率
- 接口响应时间
- 系统并发量

### 告警配置
- 库存不足告警
- 支付超时率过高告警
- 接口响应时间过长告警

## 注意事项

1. **编码规范**: 严格遵循项目开发规范，使用UTF-8编码
2. **接口文档**: 所有接口都包含完整的Swagger注解
3. **日志记录**: 关键业务操作都有详细日志
4. **事务控制**: 数据库操作考虑事务一致性
5. **异常处理**: 统一异常处理机制

## 测试建议

### 1. 功能测试
- 正常秒杀流程测试
- 库存不足场景测试
- 支付超时场景测试
- 限购功能测试

### 2. 性能测试
- 高并发下单测试
- 库存扣减压力测试
- 数据库连接池测试

### 3. 安全测试
- 防刷单测试
- 接口安全测试
- 数据一致性测试

---

**开发完成情况**: ? 所有功能已开发完成，可直接部署使用



