<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.sky.mapper.SeckillStockLogMapper">

    <!-- Insert stock log -->
    <insert id="insert" parameterType="SeckillStockLog" useGeneratedKeys="true" keyProperty="id">
        insert into seckill_stock_log (seckill_goods_id, operation_type, quantity, before_stock, after_stock,
                                      order_id, description, create_time)
        values (#{seckillGoodsId}, #{operationType}, #{quantity}, #{beforeStock}, #{afterStock},
                #{orderId}, #{description}, #{createTime})
    </insert>

    <!-- Paginated query for stock logs -->
    <select id="pageQuery" resultType="com.sky.entity.SeckillStockLog">
        select * from seckill_stock_log
        <where>
            <if test="seckillGoodsId != null">
                and seckill_goods_id = #{seckillGoodsId}
            </if>
            <if test="operationType != null">
                and operation_type = #{operationType}
            </if>
            <if test="startTime != null">
                and create_time >= #{startTime}
            </if>
            <if test="endTime != null">
                and create_time &lt;= #{endTime}
            </if>
        </where>
        order by create_time desc
    </select>

    <!-- Get stock logs by seckill goods ID -->
    <select id="getBySeckillGoodsId" resultType="com.sky.entity.SeckillStockLog">
        select * from seckill_stock_log 
        where seckill_goods_id = #{seckillGoodsId}
        order by create_time desc
    </select>

    <!-- Get statistics by operation type -->
    <select id="getStatsByType" resultType="java.util.HashMap">
        select 
            count(*) as totalCount,
            COALESCE(sum(quantity), 0) as totalQuantity
        from seckill_stock_log 
        where seckill_goods_id = #{seckillGoodsId} 
        and operation_type = #{operationType}
    </select>

</mapper>