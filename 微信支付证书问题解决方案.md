# 微信支付证书问题解决方案

## 问题描述
商家拒绝接单时出现500错误，错误信息显示：`Cannot invoke "org.apache.http.impl.client.CloseableHttpClient.execute(org.apache.http.client.methods.HttpUriRequest)" because "httpClient" is null`

## 问题原因
1. 微信支付证书文件不存在
2. 配置文件中的证书路径指向了不存在的目录 `D:\pay\`
3. `WeChatPayUtil.getClient()` 方法在证书文件不存在时返回null
4. `post()` 和 `get()` 方法直接使用null的httpClient，导致NullPointerException

## 解决方案

### 方案一：配置微信支付证书（推荐用于生产环境）
1. 创建目录 `D:\pay\`
2. 将微信支付证书文件放入该目录：
   - `apiclient_key.pem` (商户私钥文件)
   - `wechatpay_166D96F876F45C7D07CE98952A96EC980368ACFC.pem` (平台证书文件)
3. 确保配置文件中的路径正确

### 方案二：修改代码处理证书缺失（已实施）
已对以下文件进行了修改：

1. **WeChatPayUtil.java**
   - 在 `post()` 和 `get()` 方法中添加了null检查
   - 当证书文件不存在时，抛出有意义的异常信息

2. **OrderServiceImpl.java**
   - 在 `rejection()`、`cancel()`、`userCancelById()` 方法中添加了异常捕获
   - 当微信支付退款失败时，记录警告日志并继续执行订单状态更新
   - 避免因证书问题导致整个拒单操作失败

## 修改内容

### WeChatPayUtil.java
```java
// 在post()和get()方法中添加了null检查
if (httpClient == null) {
    throw new RuntimeException("微信支付证书文件不存在，无法进行支付操作。请检查配置文件中的证书路径：" + 
        weChatProperties.getPrivateKeyFilePath() + " 和 " + weChatProperties.getWeChatPayCertFilePath());
}
```

### OrderServiceImpl.java
```java
// 在退款操作中添加了异常捕获
try {
    String refund = weChatPayUtil.refund(...);
    log.info("申请退款：{}", refund);
} catch (Exception e) {
    log.warn("微信支付退款失败，可能是证书文件不存在：{}", e.getMessage());
    // 在开发环境中，如果证书文件不存在，跳过退款操作
}
```

## 测试验证
修改后，商家拒绝接单操作应该能够正常执行：
1. 订单状态会正确更新为"已取消"
2. 拒单原因会正确保存
3. 如果用户已支付，会尝试退款（证书存在时）或跳过退款（证书不存在时）
4. 不会再出现500错误

## 注意事项
- 此修改适用于开发环境
- 生产环境建议配置真实的微信支付证书
- 如果需要在开发环境中测试完整的支付流程，请按照方案一配置证书文件

